# PUTN 实机部署指引（新设备）

> 目标环境：Ubuntu 20.04 + ROS Noetic。以下步骤假设当前用户拥有 sudo 权限，并使用 `~/putncs_ws` 作为工作空间路径。

## 1. 基础依赖安装

```bash
sudo apt update
sudo apt install -y build-essential cmake git python3-pip python3-rosdep
sudo apt install -y ros-noetic-desktop-full
sudo apt install -y ros-noetic-ompl ros-noetic-robot-state-publisher \
    ros-noetic-joint-state-controller ros-noetic-velocity-controllers \
    ros-noetic-ros-control ros-noetic-eigen-conversions \
    ros-noetic-velodyne-pointcloud ros-noetic-pcl-ros \
    ros-noetic-diagnostic-updater libpcl-dev libboost-all-dev
pip3 install --user casadi==3.5.1
```

首次使用 ROS 的机器还需要初始化 rosdep：

```bash
sudo rosdep init            # 若提示已初始化可忽略
rosdep update
```

## 2. 创建工作空间并获取源码

```bash
mkdir -p ~/putncs_ws/src
cd ~/putncs_ws/src
# 将包含 A-LOAM、putn、ranger_ros、ugv_sdk、lslidar 等组件的仓库克隆到 src 下
git clone <your-putn-project-repo>.git putn_project
# 如仓库不直接位于 src，需要手动把 A-LOAM、putn、ranger_ros、ugv_sdk、lslidar 等目录放入 ~/putncs_ws/src/
```

> 提示：如果是从现有设备复制，可使用 `rsync -avz` 或者打包压缩后拷贝，保持目录结构一致。

## 3. 安装工作区依赖

```bash
cd ~/putncs_ws
rosdep install --from-paths src --ignore-src -r -y
```

## 4. 编译

```bash
cd ~/putncs_ws
catkin_make -DCMAKE_BUILD_TYPE=Release
```

首次编译后，为了方便后续使用，可在 `~/.bashrc` 末尾追加：

```bash
echo "source ~/putncs_ws/devel/setup.bash" >> ~/.bashrc
source ~/.bashrc
```

并为 MPC 脚本赋予执行权限（若仓库未携带）：

```bash
chmod +x ~/putncs_ws/src/putn/src/putn/putn_mpc/scripts/*.py
```

## 5. 实车前的硬件准备

1. **CAN 模块接线**：按照松灵说明书连接 CAN_H/CAN_L 到 USB‑CAN 适配器，并与主控电脑 USB 相连。  
2. **LiDAR 网络**：确认激光雷达与主控位于同一网段，`bringup.launch` 中 `lidar_ip` 与实机一致。  
3. **TF 外参**：根据实车安装情况，更新 `putn_launch/launch/bringup.launch` 内 `base_to_laser` 与 `camera_to_link` 的静态变换参数。

## 6. CAN 口初始化

若使用松灵提供的脚本，开机后执行一次：

```bash
source ~/putncs_ws/devel/setup.bash    # 若未写入 ~/.bashrc
rosrun ranger_bringup bringup_can2usb.bash
```

亦可手动执行以下命令（与脚本等价），确保 `can0` 口以 500 kbps 工作：

```bash
sudo modprobe gs_usb
sudo ip link set can0 up type can bitrate 500000
ifconfig -a            # 检查 can0 是否存在
sudo apt install -y can-utils
candump can0           # 监听底盘数据，验证连通性
```

## 7. 启动流程

1. 给底盘与激光雷达上电，确认 CAN 与网络连接稳定。  
2. 在主控上 `source ~/putncs_ws/devel/setup.bash`（若未自动执行）。  
3. 启动 PUTN：

   ```bash
   roslaunch putn_launch bringup.launch
   ```

   - 如在无图形环境运行，请将 `local_planner`、`controller` 的 `launch-prefix` 改为适用的终端管理方式。  
   - `bringup.launch` 默认订阅 `/lslidar_point_cloud`，若雷达话题不同需相应修改。

4. 等待 A‑LOAM 建图稳定，使用 RViz 设定目标并在 `controller` 终端按 `i` 切换至自动模式，验证车辆运动。

## 8. 常见检查项

- 编译报错多为依赖缺失，可重新执行 `rosdep install` 并确认 apt 包是否安装成功。  
- 若底盘无响应，首先确认 `candump can0` 是否能看到数据，其次检查 `ranger_mini_v2.launch` 中的 `port_name` 是否匹配（默认 `can0`）。  
- 激光点云无数据时，检查 IP、UDP 端口、以及 LiDAR 驱动节点是否在 `bringup.launch` 中成功启动。  
- TF 链断裂会导致规划失败，可用 `rosrun tf tf_echo /world /base_link` 等命令排查。

按照以上步骤，即可在新设备上构建并运行整个 PUTN 实车测试环境。***

---

## 实车调参备忘（16 线雷达离地约 1 m）

1. **静态 TF 外参**：`src/putn/src/putn/putn_launch/launch/bringup.launch`
   ```xml
   <node pkg="tf" type="static_transform_publisher" name="base_to_laser"
         args="0.10 0.0 0.70 0 0 0 /base_link /laser_link 100" />
   <node pkg="tf" type="static_transform_publisher" name="camera_to_link"
         args="-0.10 0.0 -0.70 0 0 0 /aft_mapped /base_link 10" />
   ```
   - X 方向 +0.10 m 表示雷达中心在 `base_link` 前方 10 cm；Z 方向 +0.70 m 为雷达比底盘中心高 70 cm（底盘本体约 0.3 m，高度差合计约 1 m）。
   - 现场测量若与估值不符，请同步改两个 TF，并用 `rosrun tf tf_echo /aft_mapped /base_link` 校验。

2. **局部点云高度窗口**：同一 launch 中 `local_obs_node` 的参数
   ```xml
   <param name="map/local_z_l" value="-1.2"/>
   <param name="map/local_z_u" value="0.3"/>
   ```
   扩大高度范围，避免雷达过高导致脚下地面点被滤掉。

3. **PF‑RRT* 参数**：`src/putn/src/putn/putn_planning/config/for_real_scenarios/general.yaml`
   ```yaml
   planning:
     h_surf_car: 0.35        # 车辆离地高度，近似底盘 0.3 m
     radius_fit_plane: 0.8   # 平面拟合半径，可按情况增至 1.0
     # optional: 将 w_flatness / w_slope 适当下调（如各减半），放宽拟合约束
   ```
   调低车体高度、扩大拟合邻域，有助于高位雷达找到地面平面。

4. **A‑LOAM 映射分辨率**：`src/A-LOAM/launch/aloam_velodyne_VLP_16.launch`
   ```xml
   <param name="mapping_line_resolution" type="double" value="0.10"/>
   <param name="mapping_plane_resolution" type="double" value="0.20"/>
   ```
   适度降低分辨率，生成更密集的地图；如 CPU 压力大，可把 `mapping_skip_frame` 调成 2。

5. **调试步骤提示**
   - 先手动驾驶一圈，让 A‑LOAM 建立稳定地图。
   - 切自动前，确认 `/local_plan` 存在非零控制量；`/cmd_vel` 连续输出且底盘未处于 `PARKING` 模式。
   - 若仍提示“起点无法投影”，再查看 `local_obs_node` 点云大小并微调高度窗口。

按以上调参与步骤实验，高位 16 线雷达仍可支撑 PF‑RRT* 生成路径；若效果仍不足，可结合现场条件再降低或倾斜雷达安装高度。


---

## 9. 常用调参参考

### 9.1 局部障碍高度窗口（过滤雷达上方点）
`bringup.launch` 中 `local_obs_node` 使用 `map/local_z_l` 与 `map/local_z_u` 在雷达坐标系下截取点云高度，可按如下方式保留雷达下方的地面信息、丢弃上方点：

```xml
<param name="map/local_z_l" value="-1.2"/>  <!-- 覆盖地面，视雷达离地高度可在 -1.0~-1.3 调整 -->
<param name="map/local_z_u" value="0.1"/>   <!-- 取 0 或 0.1，即基本不保留雷达上方点 -->
```

调参时在 RViz 检查 `/velodyne_points` 的 Z 分布，确保地面点落在区间内。

### 9.2 稀疏地面点云下促进 PF‑RRT* 生长
核心参数位于 `src/putn/src/putn/putn_planning/config/for_real_scenarios/general.yaml` 及 `global_planning_node.cpp`：

- `radius_fit_plane`: 调大至 0.8~1.0 m，扩大拟合半径。  
- `neighbor_radius`: 设为 1.2 左右，扩展时获取更多近邻候选。  
- `w_flatness` / `w_fit_plane`: 适当下调（如 2000→1200），并放宽 `ratio_min`/`ratio_max`（0.02→0.015，0.1→0.15），让稀疏点也能通过评估。  
- `h_surf_car`: 若过高导致投影失败，可降到 0.6 左右。  
- `step_size`: 由 0.3 降至 0.2~0.25，使树扩展更细致。  
- `max_initial_time` / `max_iter`: 在 `global_planning_node.cpp` 中适度增大，为树提供更多生长时间。

建议每次仅调整一两项并重新启动 `roslaunch putn_launch bringup.launch`，在 RViz 中观察 PF‑RRT* 树的生成情况，再逐步收敛到合适配置。

